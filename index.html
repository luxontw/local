<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PostMessage Fuzzer</title>
    <style>
        body { font-family: monospace; padding: 10px; background: #222; color: #fff; }
        .card { border: 1px solid #555; padding: 15px; margin-bottom: 20px; border-radius: 5px; background: #333; }
        h2 { margin-top: 0; color: #0f0; border-bottom: 1px solid #555; padding-bottom: 5px; }
        button { width: 100%; padding: 15px; margin: 5px 0; font-size: 16px; font-weight: bold; cursor: pointer; background: #444; color: #fff; border: 1px solid #777; }
        button:active { background: #0f0; color: #000; }
        #log { height: 200px; overflow-y: scroll; background: #000; border: 1px solid #555; padding: 5px; font-size: 12px; white-space: pre-wrap; color: #aaa; }
        input { width: 70%; padding: 10px; }
        .btn-small { width: 25%; }
    </style>
</head>
<body>

    <h1>PostMessage 盲測器</h1>
    <div id="log">準備就緒...</div>

    <div class="card">
        <h2>1. 自動轟炸 (Auto Fuzz)</h2>
        <p>點擊下方按鈕，會連續發送多種格式指令。</p>
        
        <button onclick="fuzzSettings()">測試 A: 開啟設定 (Settings)</button>
        <button onclick="fuzzBrowser()">測試 B: 開啟瀏覽器 (Open URL)</button>
        <button onclick="fuzzSystem()">測試 C: 系統指令 (Back/Home)</button>
    </div>

    <div class="card">
        <h2>2. 手動發送</h2>
        <input type="text" id="manualInput" value='{"action":"openSettings"}'>
        <button class="btn-small" onclick="sendManual()">發送</button>
    </div>

    <script>
        var bridge = window.BooksComJsBridge;
        var logBox = document.getElementById('log');

        function log(msg) {
            logBox.innerHTML = "> " + msg + "\n" + logBox.innerHTML;
        }

        function send(payload) {
            if (!bridge) {
                log("錯誤: 找不到 Bridge 物件");
                return;
            }
            try {
                // 嘗試發送原始物件 (有些 Bridge 接受 Object)
                // bridge.postMessage(payload); 
                
                // 嘗試發送字串化 JSON (最常見)
                var str = (typeof payload === 'object') ? JSON.stringify(payload) : payload;
                bridge.postMessage(str);
                
                log("已發送: " + str);
            } catch (e) {
                log("發送失敗: " + e.message);
            }
        }

        // --- 測試組 A: 設定 ---
        function fuzzSettings() {
            log("--- 開始測試設定指令 ---");
            const keys = ["action", "type", "cmd", "command", "event", "method"];
            const values = ["openSettings", "settings", "setting", "wifi", "wifiSettings", "debug", "devMode"];
            
            // 1. 簡單字串
            values.forEach(v => send(v));

            // 2. 常見 JSON 組合
            keys.forEach(k => {
                values.forEach(v => {
                    var data = {};
                    data[k] = v;
                    send(data);
                });
            });
            
            // 3. 博客來/App 特定猜測
            send({"action": "open_settings"});
            send({"func": "openSettings"});
            send({"target": "settings"});
        }

        // --- 測試組 B: 瀏覽器 ---
        function fuzzBrowser() {
            log("--- 開始測試瀏覽器指令 ---");
            const url = "https://www.google.com";
            
            // 常見格式
            send({"action": "openUrl", "url": url});
            send({"action": "openBrowser", "url": url});
            send({"action": "link", "url": url});
            send({"type": "open", "data": url});
            send({"cmd": "loadUrl", "url": url});
            
            // 針對 Store App 常見的格式
            send({"action": "scheme", "url": url});
            send({"action": "external", "url": url});
        }

        // --- 測試組 C: 系統 ---
        function fuzzSystem() {
            log("--- 開始測試系統指令 ---");
            const cmds = ["goBack", "back", "home", "finish", "close", "exit", "share", "copy"];
            
            cmds.forEach(v => {
                send(v);
                send({"action": v});
                send({"type": v});
            });
        }

        function sendManual() {
            var val = document.getElementById('manualInput').value;
            try {
                // 嘗試解析為 JSON 發送，如果不是 JSON 就送字串
                try {
                    var obj = JSON.parse(val);
                    send(obj);
                } catch(e) {
                    send(val);
                }
            } catch(e) {
                log("錯誤: " + e.message);
            }
        }
    </script>
</body>
</html>
